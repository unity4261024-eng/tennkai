<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>VR立方体展開図 - 厚み付き版</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js"></script>
  <script>
    AFRAME.registerComponent('cube-unfold', {
      schema: {
        isUnfolded: {type: 'boolean', default: false},
        patternIndex: {type: 'int', default: 0}
      },
      
      init: function() {
        console.log('Cube component initialized');
        this.faces = [];
        this.thickness = 0.08;
        this.faceSize = 1;
        this.baseFace = null;
        this.setupFaces();
        this.isAnimating = false;
        
        // 展開図のパターン定義（面が接続された状態）
        this.unfoldPatterns = [
          {
            name: '十字型',
            positions: [
              {name: 'bottom', pos: {x:0, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'front', pos: {x:0, y:1, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'left', pos: {x:-1, y:1, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'right', pos: {x:1, y:1, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'back', pos: {x:0, y:2, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'top', pos: {x:0, y:3, z:0}, rot: {x:0, y:0, z:0}}
            ]
          },
          {
            name: 'T字型',
            positions: [
              {name: 'bottom', pos: {x:0, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'front', pos: {x:1, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'right', pos: {x:2, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'back', pos: {x:3, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'left', pos: {x:1, y:1, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'top', pos: {x:2, y:1, z:0}, rot: {x:0, y:0, z:0}}
            ]
          },
          {
            name: 'L字型',
            positions: [
              {name: 'bottom', pos: {x:0, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'front', pos: {x:1, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'left', pos: {x:0, y:1, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'right', pos: {x:1, y:1, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'back', pos: {x:0, y:2, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'top', pos: {x:1, y:2, z:0}, rot: {x:0, y:0, z:0}}
            ]
          },
          {
            name: '階段型',
            positions: [
              {name: 'bottom', pos: {x:0, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'front', pos: {x:1, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'left', pos: {x:1, y:1, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'right', pos: {x:2, y:1, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'back', pos: {x:2, y:2, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'top', pos: {x:3, y:2, z:0}, rot: {x:0, y:0, z:0}}
            ]
          },
          {
            name: 'Z字型',
            positions: [
              {name: 'bottom', pos: {x:0, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'front', pos: {x:1, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'left', pos: {x:1, y:1, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'right', pos: {x:2, y:1, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'back', pos: {x:2, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'top', pos: {x:3, y:0, z:0}, rot: {x:0, y:0, z:0}}
            ]
          },
          {
            name: '一直線型',
            positions: [
              {name: 'bottom', pos: {x:0, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'front', pos: {x:1, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'right', pos: {x:2, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'back', pos: {x:3, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'left', pos: {x:4, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'top', pos: {x:5, y:0, z:0}, rot: {x:0, y:0, z:0}}
            ]
          }
        ];
      },
      
      setupFaces: function() {
        const el = this.el;
        const thickness = this.thickness;
        const offset = 0.5 + thickness/2;
        
        // 立方体の6面を定義
        const faceConfigs = [
          {name: 'front', pos: [0, 0, offset], rot: [0, 0, 0], color: '#FF6B6B'},
          {name: 'back', pos: [0, 0, -offset], rot: [0, 180, 0], color: '#4ECDC4'},
          {name: 'right', pos: [offset, 0, 0], rot: [0, 90, 0], color: '#45B7D1'},
          {name: 'left', pos: [-offset, 0, 0], rot: [0, -90, 0], color: '#FFA07A'},
          {name: 'top', pos: [0, offset, 0], rot: [-90, 0, 0], color: '#98D8C8'},
          {name: 'bottom', pos: [0, -offset, 0], rot: [90, 0, 0], color: '#F7DC6F'}
        ];
        
        faceConfigs.forEach((config) => {
          const faceEl = document.createElement('a-box');
          faceEl.setAttribute('width', this.faceSize);
          faceEl.setAttribute('height', this.faceSize);
          faceEl.setAttribute('depth', thickness);
          faceEl.setAttribute('color', config.color);
          faceEl.setAttribute('position', config.pos.join(' '));
          faceEl.setAttribute('rotation', config.rot.join(' '));
          faceEl.setAttribute('data-face-name', config.name);
          
          // 黒い枠線を追加（4辺）
          const edgeThickness = 0.02;
          const edgeColor = '#000000';
          const halfSize = this.faceSize / 2;
          const edgeDepth = thickness + 0.002;
          
          // 上辺
          const topEdge = document.createElement('a-box');
          topEdge.setAttribute('width', this.faceSize);
          topEdge.setAttribute('height', edgeThickness);
          topEdge.setAttribute('depth', edgeDepth);
          topEdge.setAttribute('color', edgeColor);
          topEdge.setAttribute('position', `0 ${halfSize} 0`);
          faceEl.appendChild(topEdge);
          
          // 下辺
          const bottomEdge = document.createElement('a-box');
          bottomEdge.setAttribute('width', this.faceSize);
          bottomEdge.setAttribute('height', edgeThickness);
          bottomEdge.setAttribute('depth', edgeDepth);
          bottomEdge.setAttribute('color', edgeColor);
          bottomEdge.setAttribute('position', `0 ${-halfSize} 0`);
          faceEl.appendChild(bottomEdge);
          
          // 左辺
          const leftEdge = document.createElement('a-box');
          leftEdge.setAttribute('width', edgeThickness);
          leftEdge.setAttribute('height', this.faceSize);
          leftEdge.setAttribute('depth', edgeDepth);
          leftEdge.setAttribute('color', edgeColor);
          leftEdge.setAttribute('position', `${-halfSize} 0 0`);
          faceEl.appendChild(leftEdge);
          
          // 右辺
          const rightEdge = document.createElement('a-box');
          rightEdge.setAttribute('width', edgeThickness);
          rightEdge.setAttribute('height', this.faceSize);
          rightEdge.setAttribute('depth', edgeDepth);
          rightEdge.setAttribute('color', edgeColor);
          rightEdge.setAttribute('position', `${halfSize} 0 0`);
          faceEl.appendChild(rightEdge);
          
          // bottom面だけクリック可能にする
          if (config.name === 'bottom') {
            faceEl.classList.add('grabbable');
            this.baseFace = faceEl;
          }
          
          // テキストラベル
          const text = document.createElement('a-text');
          text.setAttribute('value', config.name);
          text.setAttribute('align', 'center');
          text.setAttribute('position', '0 0 ' + (thickness/2 + 0.01));
          text.setAttribute('scale', '0.4 0.4 0.4');
          text.setAttribute('color', '#000');
          faceEl.appendChild(text);
          
          el.appendChild(faceEl);
          this.faces.push({
            el: faceEl,
            name: config.name,
            foldedPos: config.pos,
            foldedRot: config.rot
          });
        });
        
        console.log('Created', this.faces.length, 'faces');
      },
      
      toggle: function() {
        if (this.isAnimating) return;
        console.log('Toggling cube');
        this.data.isUnfolded = !this.data.isUnfolded;
        this.animate();
      },
      
      changePattern: function(index) {
        if (this.isAnimating) return;
        console.log('Changing pattern to:', index);
        this.data.patternIndex = index;
        if (this.data.isUnfolded) {
          this.animate();
        }
      },
      
      animate: function() {
        this.isAnimating = true;
        const duration = 2000;
        const pattern = this.unfoldPatterns[this.data.patternIndex];
        
        this.faces.forEach((face) => {
          let targetPos, targetRot;
          
          if (this.data.isUnfolded) {
            const unfoldData = pattern.positions.find(f => f.name === face.name);
            targetPos = unfoldData.pos;
            targetRot = unfoldData.rot;
          } else {
            targetPos = {x: face.foldedPos[0], y: face.foldedPos[1], z: face.foldedPos[2]};
            targetRot = {x: face.foldedRot[0], y: face.foldedRot[1], z: face.foldedRot[2]};
          }
          
          face.el.setAttribute('animation__position', {
            property: 'position',
            to: `${targetPos.x} ${targetPos.y} ${targetPos.z}`,
            dur: duration,
            easing: 'easeInOutQuad'
          });
          
          face.el.setAttribute('animation__rotation', {
            property: 'rotation',
            to: `${targetRot.x} ${targetRot.y} ${targetRot.z}`,
            dur: duration,
            easing: 'easeInOutQuad'
          });
        });
        
        setTimeout(() => {
          this.isAnimating = false;
        }, duration);
      }
    });
    
    // 左コントローラーのスティックで移動
    AFRAME.registerComponent('thumbstick-locomotion', {
      init: function() {
        this.rig = document.querySelector('#rig');
        this.speed = 0.1;
      },
      
      tick: function() {
        const el = this.el;
        const gamepad = el.components['oculus-touch-controls'];
        
        if (gamepad && gamepad.controller) {
          const axes = gamepad.controller.gamepad.axes;
          if (axes && axes.length >= 2) {
            const x = axes[0]; // 左右
            const y = axes[1]; // 前後
            
            if (Math.abs(x) > 0.1 || Math.abs(y) > 0.1) {
              const camera = document.querySelector('#camera');
              const rotation = camera.object3D.rotation;
              
              // カメラの向きに基づいて移動方向を計算
              const direction = new THREE.Vector3();
              direction.x = x * Math.cos(rotation.y) + y * Math.sin(rotation.y);
              direction.z = x * Math.sin(rotation.y) - y * Math.cos(rotation.y);
              
              const position = this.rig.object3D.position;
              position.x += direction.x * this.speed;
              position.z += direction.z * this.speed;
            }
          }
        }
      }
    });
    
    // 立方体を掴んで全体を動かすコンポーネント
    AFRAME.registerComponent('grabbable-cube', {
      init: function() {
        const el = this.el;
        this.grabbed = false;
        this.grabber = null;
        this.initialGrabberPos = new THREE.Vector3();
        this.initialCubePos = new THREE.Vector3();
        
        // bottom面を取得
        this.bottomFace = null;
        setTimeout(() => {
          this.bottomFace = el.querySelector('[data-face-name="bottom"]');
          if (this.bottomFace) {
            this.setupGrabEvents();
          }
        }, 100);
      },
      
      setupGrabEvents: function() {
        // マウスでの掴み
        this.bottomFace.addEventListener('mousedown', (evt) => {
          this.grabbed = true;
          this.grabber = evt.detail.cursorEl.parentEl;
          this.initialGrabberPos.copy(this.grabber.object3D.position);
          this.initialCubePos.copy(this.el.object3D.position);
          console.log('Grabbed cube by mouse');
        });
        
        // VRコントローラーでの掴み
        const scene = this.el.sceneEl;
        const leftHand = scene.querySelector('#leftHand');
        const rightHand = scene.querySelector('#rightHand');
        
        if (leftHand) {
          leftHand.addEventListener('gripdown', (evt) => {
            const raycaster = leftHand.components.raycaster;
            if (raycaster && raycaster.intersectedEls.includes(this.bottomFace)) {
              this.grabbed = true;
              this.grabber = leftHand;
              this.initialGrabberPos.copy(this.grabber.object3D.position);
              this.initialCubePos.copy(this.el.object3D.position);
              console.log('Grabbed cube by left controller');
            }
          });
          
          leftHand.addEventListener('gripup', () => {
            if (this.grabber === leftHand) {
              this.grabbed = false;
              this.grabber = null;
            }
          });
        }
        
        if (rightHand) {
          rightHand.addEventListener('gripdown', (evt) => {
            const raycaster = rightHand.components.raycaster;
            if (raycaster && raycaster.intersectedEls.includes(this.bottomFace)) {
              this.grabbed = true;
              this.grabber = rightHand;
              this.initialGrabberPos.copy(this.grabber.object3D.position);
              this.initialCubePos.copy(this.el.object3D.position);
              console.log('Grabbed cube by right controller');
            }
          });
          
          rightHand.addEventListener('gripup', () => {
            if (this.grabber === rightHand) {
              this.grabbed = false;
              this.grabber = null;
            }
          });
        }
        
        // 離す
        window.addEventListener('mouseup', () => {
          this.grabbed = false;
          this.grabber = null;
        });
      },
      
      tick: function() {
        if (this.grabbed && this.grabber) {
          const currentGrabberPos = this.grabber.object3D.position;
          const offset = new THREE.Vector3().subVectors(currentGrabberPos, this.initialGrabberPos);
          const newPos = new THREE.Vector3().addVectors(this.initialCubePos, offset);
          this.el.object3D.position.copy(newPos);
        }
      }
    });
    
    AFRAME.registerComponent('clickable-button', {
      schema: {
        action: {type: 'string', default: 'toggle'}
      },
      
      init: function() {
        const el = this.el;
        
        el.addEventListener('mouseenter', () => {
          el.setAttribute('scale', '1.1 1.1 1.1');
        });
        
        el.addEventListener('mouseleave', () => {
          el.setAttribute('scale', '1 1 1');
        });
        
        // マウスクリック
        el.addEventListener('click', (evt) => {
          this.handleClick();
        });
        
        // VRコントローラーのトリガー
        el.addEventListener('triggerdown', (evt) => {
          this.handleClick();
        });
      },
      
      handleClick: function() {
        console.log('Button clicked:', this.data.action);
        const cube = document.querySelector('#cube');
        
        if (this.data.action === 'reset') {
          // 立方体の状態に戻す
          if (cube.components['cube-unfold'].data.isUnfolded) {
            cube.components['cube-unfold'].toggle();
          }
        } else {
          const patternIndex = parseInt(this.data.action);
          cube.components['cube-unfold'].changePattern(patternIndex);
          const patterns = cube.components['cube-unfold'].unfoldPatterns;
          const infoText = document.querySelector('#pattern-info');
          infoText.setAttribute('value', '現在: ' + patterns[patternIndex].name);
          // パターン選択時に自動で展開
          if (!cube.components['cube-unfold'].data.isUnfolded) {
            cube.components['cube-unfold'].toggle();
          }
        }
      }
    });
  </script>
</head>
<body>
  <a-scene>
    <!-- カメラ -->
    <a-entity id="rig" position="0 1.6 5" movement-controls="controls: checkpoint; speed: 0.15">
      <a-entity id="camera" camera look-controls wasd-controls>
        <a-cursor
          color="#00FF00"
          opacity="0.8"
          fuse="false"
          raycaster="objects: .clickable, .grabbable">
        </a-cursor>
      </a-entity>
      
      <!-- Quest用コントローラー -->
      <a-entity 
        id="leftHand"
        oculus-touch-controls="hand: left"
        raycaster="objects: .clickable, .grabbable; lineColor: red; lineOpacity: 0.5"
        thumbstick-locomotion></a-entity>
      
      <a-entity 
        id="rightHand"
        oculus-touch-controls="hand: right"
        raycaster="objects: .clickable, .grabbable; lineColor: blue; lineOpacity: 0.5"
        laser-controls></a-entity>
    </a-entity>
    
    <!-- 立方体 -->
    <a-entity id="cube" 
              position="0 1.5 -2"
              cube-unfold
              grabbable-cube>
    </a-entity>
    
    
    <!-- メインコントロールパネル -->
    <a-entity id="control-panel" position="-2.8 1.5 -2">
      <a-plane width="2.2" height="2.5" color="#2C3E50" opacity="0.95"></a-plane>
      
      <a-text value="展開図コントロール" 
              position="0 1 0.05" 
              align="center"
              width="2"
              color="#ECF0F1"></a-text>
      
      <!-- 戻るボタン -->
      <a-box class="clickable"
             position="0 0.6 0.1"
             width="1.8"
             height="0.4"
             depth="0.15"
             color="#27AE60"
             clickable-button="action: reset">
        <a-text value="戻る" 
                align="center" 
                position="0 0 0.08" 
                width="2.5"
                color="#FFF"></a-text>
      </a-box>
      
      <a-text value="--- 展開パターン ---" 
              position="0 0.15 0.05" 
              align="center"
              width="2"
              color="#F39C12"></a-text>
      
      <!-- パターン選択ボタン -->
      <a-box class="clickable" position="-0.55 -0.2 0.1" width="0.8" height="0.35" depth="0.12" color="#3498DB" clickable-button="action: 0">
        <a-text value="① 十字型" align="center" position="0 0 0.07" width="0.7" color="#FFF"></a-text>
      </a-box>
      
      <a-box class="clickable" position="0.55 -0.2 0.1" width="0.8" height="0.35" depth="0.12" color="#3498DB" clickable-button="action: 1">
        <a-text value="② T字型" align="center" position="0 0 0.07" width="0.7" color="#FFF"></a-text>
      </a-box>
      
      <a-box class="clickable" position="-0.55 -0.6 0.1" width="0.8" height="0.35" depth="0.12" color="#3498DB" clickable-button="action: 2">
        <a-text value="③ L字型" align="center" position="0 0 0.07" width="0.7" color="#FFF"></a-text>
      </a-box>
      
      <a-box class="clickable" position="0.55 -0.6 0.1" width="0.8" height="0.35" depth="0.12" color="#3498DB" clickable-button="action: 3">
        <a-text value="④ 階段型" align="center" position="0 0 0.07" width="0.7" color="#FFF"></a-text>
      </a-box>
      
      <a-box class="clickable" position="-0.55 -1.0 0.1" width="0.8" height="0.35" depth="0.12" color="#3498DB" clickable-button="action: 4">
        <a-text value="⑤ Z字型" align="center" position="0 0 0.07" width="0.7" color="#FFF"></a-text>
      </a-box>
      
      <a-box class="clickable" position="0.55 -1.0 0.1" width="0.8" height="0.35" depth="0.12" color="#3498DB" clickable-button="action: 5">
        <a-text value="⑥ 一直線" align="center" position="0 0 0.07" width="0.7" color="#FFF"></a-text>
      </a-box>
    </a-entity>
    
    <!-- 現在のパターン表示 -->
    <a-text id="pattern-info"
            value="現在: 十字型"
            position="0 2.5 -2"
            align="center"
            width="2"
            color="#F39C12"></a-text>
    
    <!-- 説明文 -->
    <a-text value="左スティック: 移動 / グリップ: 立方体を掴む\nトリガー: ボタン操作 / 両手のコントローラーが使えます"
            position="0 2.8 -2"
            align="center"
            width="3.5"
            color="#ECF0F1"></a-text>
    
    <!-- 環境 -->
    <a-plane position="0 0 0" 
             rotation="-90 0 0" 
             width="30" 
             height="30" 
             color="#34495E"></a-plane>
    
    <a-sky color="#1A1A2E"></a-sky>
    
    <!-- ライト -->
    <a-light type="ambient" color="#999"></a-light>
    <a-light type="directional" color="#FFF" intensity="0.7" position="-1 2 1"></a-light>
  </a-scene>
</body>
</html>