<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>VR立方体展開図 - Meta Quest対応</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js"></script>
  <script>
    AFRAME.registerComponent('cube-unfold', {
      schema: {
        isUnfolded: {type: 'boolean', default: false},
        patternIndex: {type: 'int', default: 0}
      },
      
      init: function() {
        console.log('Cube component initialized');
        this.faces = [];
        this.setupFaces();
        this.isAnimating = false;
        
        // 展開図のパターン定義
        this.unfoldPatterns = [
          {
            name: '十字型',
            positions: [
              {name: 'front', pos: {x:0, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'back', pos: {x:0, y:0, z:2}, rot: {x:0, y:0, z:0}},
              {name: 'right', pos: {x:1, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'left', pos: {x:-1, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'top', pos: {x:0, y:1, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'bottom', pos: {x:0, y:-1, z:0}, rot: {x:0, y:0, z:0}}
            ]
          },
          {
            name: 'T字型',
            positions: [
              {name: 'front', pos: {x:0, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'back', pos: {x:1, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'right', pos: {x:2, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'left', pos: {x:3, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'top', pos: {x:0, y:1, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'bottom', pos: {x:1, y:1, z:0}, rot: {x:0, y:0, z:0}}
            ]
          },
          {
            name: 'L字型A',
            positions: [
              {name: 'front', pos: {x:0, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'back', pos: {x:1, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'right', pos: {x:0, y:1, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'left', pos: {x:0, y:2, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'top', pos: {x:1, y:1, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'bottom', pos: {x:1, y:2, z:0}, rot: {x:0, y:0, z:0}}
            ]
          },
          {
            name: '階段型',
            positions: [
              {name: 'front', pos: {x:0, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'back', pos: {x:1, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'right', pos: {x:1, y:1, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'left', pos: {x:2, y:1, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'top', pos: {x:2, y:2, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'bottom', pos: {x:3, y:2, z:0}, rot: {x:0, y:0, z:0}}
            ]
          },
          {
            name: '一直線型',
            positions: [
              {name: 'front', pos: {x:0, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'back', pos: {x:1, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'right', pos: {x:2, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'left', pos: {x:3, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'top', pos: {x:4, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'bottom', pos: {x:5, y:0, z:0}, rot: {x:0, y:0, z:0}}
            ]
          },
          {
            name: 'Z字型',
            positions: [
              {name: 'front', pos: {x:0, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'back', pos: {x:1, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'right', pos: {x:1, y:1, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'left', pos: {x:2, y:1, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'top', pos: {x:2, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'bottom', pos: {x:3, y:0, z:0}, rot: {x:0, y:0, z:0}}
            ]
          },
          {
            name: 'W字型',
            positions: [
              {name: 'front', pos: {x:0, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'back', pos: {x:1, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'right', pos: {x:1, y:-1, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'left', pos: {x:2, y:-1, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'top', pos: {x:2, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'bottom', pos: {x:3, y:0, z:0}, rot: {x:0, y:0, z:0}}
            ]
          },
          {
            name: 'L字型B',
            positions: [
              {name: 'front', pos: {x:0, y:0, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'back', pos: {x:0, y:1, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'right', pos: {x:1, y:1, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'left', pos: {x:2, y:1, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'top', pos: {x:3, y:1, z:0}, rot: {x:0, y:0, z:0}},
              {name: 'bottom', pos: {x:2, y:2, z:0}, rot: {x:0, y:0, z:0}}
            ]
          }
        ];
      },
      
      setupFaces: function() {
        const el = this.el;
        
        this.faceDefinitions = [
          {name: 'front', pos: {x:0, y:0, z:0.5}, rot: {x:0, y:0, z:0}, color: '#FF6B6B'},
          {name: 'back', pos: {x:0, y:0, z:-0.5}, rot: {x:0, y:180, z:0}, color: '#4ECDC4'},
          {name: 'right', pos: {x:0.5, y:0, z:0}, rot: {x:0, y:90, z:0}, color: '#45B7D1'},
          {name: 'left', pos: {x:-0.5, y:0, z:0}, rot: {x:0, y:-90, z:0}, color: '#FFA07A'},
          {name: 'top', pos: {x:0, y:0.5, z:0}, rot: {x:-90, y:0, z:0}, color: '#98D8C8'},
          {name: 'bottom', pos: {x:0, y:-0.5, z:0}, rot: {x:90, y:0, z:0}, color: '#F7DC6F'}
        ];
        
        this.faceDefinitions.forEach((face) => {
          const faceEl = document.createElement('a-plane');
          faceEl.setAttribute('width', '1');
          faceEl.setAttribute('height', '1');
          faceEl.setAttribute('color', face.color);
          faceEl.setAttribute('position', face.pos);
          faceEl.setAttribute('rotation', face.rot);
          faceEl.setAttribute('data-face-name', face.name);
          
          const text = document.createElement('a-text');
          text.setAttribute('value', face.name);
          text.setAttribute('align', 'center');
          text.setAttribute('position', '0 0 0.01');
          text.setAttribute('scale', '0.5 0.5 0.5');
          text.setAttribute('color', '#000');
          faceEl.appendChild(text);
          
          el.appendChild(faceEl);
          this.faces.push(faceEl);
        });
      },
      
      toggle: function() {
        if (this.isAnimating) return;
        console.log('Toggling cube, current state:', this.data.isUnfolded);
        this.data.isUnfolded = !this.data.isUnfolded;
        this.animate();
      },
      
      changePattern: function(index) {
        if (this.isAnimating) return;
        console.log('Changing pattern to:', index);
        this.data.patternIndex = index;
        if (this.data.isUnfolded) {
          this.animate();
        }
      },
      
      animate: function() {
        this.isAnimating = true;
        const duration = 2000;
        const pattern = this.unfoldPatterns[this.data.patternIndex];
        console.log('Animating to pattern:', pattern.name);
        
        this.faces.forEach((faceEl) => {
          const faceName = faceEl.getAttribute('data-face-name');
          let targetPos, targetRot;
          
          if (this.data.isUnfolded) {
            const unfoldedData = pattern.positions.find(f => f.name === faceName);
            targetPos = unfoldedData.pos;
            targetRot = unfoldedData.rot;
          } else {
            const foldedData = this.faceDefinitions.find(f => f.name === faceName);
            targetPos = foldedData.pos;
            targetRot = foldedData.rot;
          }
          
          faceEl.setAttribute('animation__position', {
            property: 'position',
            to: `${targetPos.x} ${targetPos.y} ${targetPos.z}`,
            dur: duration,
            easing: 'easeInOutQuad'
          });
          
          faceEl.setAttribute('animation__rotation', {
            property: 'rotation',
            to: `${targetRot.x} ${targetRot.y} ${targetRot.z}`,
            dur: duration,
            easing: 'easeInOutQuad'
          });
        });
        
        setTimeout(() => {
          this.isAnimating = false;
        }, duration);
      }
    });
    
    // クリック可能なボタンコンポーネント
    AFRAME.registerComponent('clickable-button', {
      schema: {
        action: {type: 'string', default: 'toggle'}
      },
      
      init: function() {
        const el = this.el;
        
        // ホバー効果
        el.addEventListener('mouseenter', () => {
          el.setAttribute('scale', '1.1 1.1 1.1');
        });
        
        el.addEventListener('mouseleave', () => {
          el.setAttribute('scale', '1 1 1');
        });
        
        // クリックイベント
        el.addEventListener('click', () => {
          console.log('Button clicked:', this.data.action);
          const cube = document.querySelector('#cube');
          
          if (this.data.action === 'toggle') {
            cube.components['cube-unfold'].toggle();
          } else {
            const patternIndex = parseInt(this.data.action);
            cube.components['cube-unfold'].changePattern(patternIndex);
            const patterns = cube.components['cube-unfold'].unfoldPatterns;
            const infoText = document.querySelector('#pattern-info');
            infoText.setAttribute('value', '現在: ' + patterns[patternIndex].name);
          }
        });
      }
    });
  </script>
</head>
<body>
  <a-scene>
    <!-- カメラ -->
    <a-entity id="rig" position="0 1.6 3">
      <a-entity id="camera" camera look-controls wasd-controls>
        <!-- デスクトップ用カーソル -->
        <a-cursor
          color="#00FF00"
          opacity="0.8"
          fuse="false"
          raycaster="objects: .clickable">
        </a-cursor>
      </a-entity>
      
      <!-- Quest用コントローラー -->
      <a-entity 
        id="leftHand"
        oculus-touch-controls="hand: left"
        raycaster="objects: .clickable; lineColor: red; lineOpacity: 0.5"></a-entity>
      
      <a-entity 
        id="rightHand"
        oculus-touch-controls="hand: right"
        raycaster="objects: .clickable; lineColor: blue; lineOpacity: 0.5"
        laser-controls></a-entity>
    </a-entity>
    
    <!-- 立方体 -->
    <a-entity id="cube" 
              position="0 1.5 -1.5"
              cube-unfold>
    </a-entity>
    
    <!-- メインコントロールパネル -->
    <a-entity id="control-panel" position="-2 1.5 -2">
      <!-- 背景パネル -->
      <a-plane width="2" height="2.5" color="#2C3E50" opacity="0.95"></a-plane>
      
      <!-- タイトル -->
      <a-text value="展開図コントロール" 
              position="0 1 0.05" 
              align="center"
              width="1.8"
              color="#ECF0F1"></a-text>
      
      <!-- 展開/折りたたみボタン -->
      <a-box class="clickable"
             position="0 0.6 0.1"
             width="1.5"
             height="0.4"
             depth="0.15"
             color="#27AE60"
             clickable-button="action: toggle">
        <a-text value="展開 / 折りたたみ" 
                align="center" 
                position="0 0 0.08" 
                width="1.4"
                color="#FFF"></a-text>
      </a-box>
      
      <!-- パターンタイトル -->
      <a-text value="--- 展開図パターン ---" 
              position="0 0.15 0.05" 
              align="center"
              width="1.8"
              color="#F39C12"></a-text>
      
      <!-- パターン選択ボタン -->
      <a-box class="clickable" position="-0.5 -0.2 0.1" width="0.7" height="0.35" depth="0.12" color="#3498DB" clickable-button="action: 0">
        <a-text value="1.十字型" align="center" position="0 0 0.07" width="0.6" color="#FFF"></a-text>
      </a-box>
      
      <a-box class="clickable" position="0.5 -0.2 0.1" width="0.7" height="0.35" depth="0.12" color="#3498DB" clickable-button="action: 1">
        <a-text value="2.T字型" align="center" position="0 0 0.07" width="0.6" color="#FFF"></a-text>
      </a-box>
      
      <a-box class="clickable" position="-0.5 -0.6 0.1" width="0.7" height="0.35" depth="0.12" color="#3498DB" clickable-button="action: 2">
        <a-text value="3.L字型A" align="center" position="0 0 0.07" width="0.6" color="#FFF"></a-text>
      </a-box>
      
      <a-box class="clickable" position="0.5 -0.6 0.1" width="0.7" height="0.35" depth="0.12" color="#3498DB" clickable-button="action: 3">
        <a-text value="4.階段型" align="center" position="0 0 0.07" width="0.6" color="#FFF"></a-text>
      </a-box>
      
      <a-box class="clickable" position="-0.5 -1.0 0.1" width="0.7" height="0.35" depth="0.12" color="#3498DB" clickable-button="action: 4">
        <a-text value="5.一直線" align="center" position="0 0 0.07" width="0.6" color="#FFF"></a-text>
      </a-box>
      
      <a-box class="clickable" position="0.5 -1.0 0.1" width="0.7" height="0.35" depth="0.12" color="#3498DB" clickable-button="action: 5">
        <a-text value="6.Z字型" align="center" position="0 0 0.07" width="0.6" color="#FFF"></a-text>
      </a-box>
      
      <a-box class="clickable" position="-0.5 -1.4 0.1" width="0.7" height="0.35" depth="0.12" color="#3498DB" clickable-button="action: 6">
        <a-text value="7.W字型" align="center" position="0 0 0.07" width="0.6" color="#FFF"></a-text>
      </a-box>
      
      <a-box class="clickable" position="0.5 -1.4 0.1" width="0.7" height="0.35" depth="0.12" color="#3498DB" clickable-button="action: 7">
        <a-text value="8.L字型B" align="center" position="0 0 0.07" width="0.6" color="#FFF"></a-text>
      </a-box>
    </a-entity>
    
    <!-- 現在のパターン表示 -->
    <a-text id="pattern-info"
            value="現在: 十字型"
            position="0 2.3 -1.5"
            align="center"
            width="3"
            color="#F39C12"></a-text>
    
    <!-- 説明文 -->
    <a-text value="画面中央の緑のカーソルをボタンに合わせてクリック\nQuestではコントローラーで操作"
            position="0 2.8 -1.5"
            align="center"
            width="4"
            color="#ECF0F1"></a-text>
    
    <!-- 環境 -->
    <a-plane position="0 0 0" 
             rotation="-90 0 0" 
             width="30" 
             height="30" 
             color="#34495E"></a-plane>
    
    <a-sky color="#1A1A2E"></a-sky>
    
    <!-- ライト -->
    <a-light type="ambient" color="#999"></a-light>
    <a-light type="directional" color="#FFF" intensity="0.7" position="-1 2 1"></a-light>
  </a-scene>
</body>
</html>