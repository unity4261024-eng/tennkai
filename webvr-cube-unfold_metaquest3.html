<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>VR立方体展開図 - Meta Quest 3 対応</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js"></script>
  <script>
    const LAYOUT_SPACING = 1.05;

    AFRAME.registerComponent('cube-unfold', {
      schema: {
        isUnfolded: {type: 'boolean', default: false},
        patternIndex: {type: 'int', default: 0}
      },

      init: function () {
        this.faces = [];
        this.isAnimating = false;
        this.animationDuration = 1200;
        this.layoutSpacing = LAYOUT_SPACING;

        this.patternInfoEl = null;
        this.stateInfoEl = null;

        this.faceDefinitions = [
          {name: 'front', pos: {x: 0, y: 0, z: 0.5}, rot: {x: 0, y: 0, z: 0}, color: '#FF6B6B'},
          {name: 'back', pos: {x: 0, y: 0, z: -0.5}, rot: {x: 0, y: 180, z: 0}, color: '#4ECDC4'},
          {name: 'right', pos: {x: 0.5, y: 0, z: 0}, rot: {x: 0, y: 90, z: 0}, color: '#45B7D1'},
          {name: 'left', pos: {x: -0.5, y: 0, z: 0}, rot: {x: 0, y: -90, z: 0}, color: '#FFA07A'},
          {name: 'top', pos: {x: 0, y: 0.5, z: 0}, rot: {x: -90, y: 0, z: 0}, color: '#98D8C8'},
          {name: 'bottom', pos: {x: 0, y: -0.5, z: 0}, rot: {x: 90, y: 0, z: 0}, color: '#F7DC6F'}
        ];

        this.unfoldPatterns = [
          {
            name: '十字型',
            layout: {
              front: {x: 0, y: 0},
              right: {x: 1, y: 0},
              left: {x: -1, y: 0},
              top: {x: 0, y: 1},
              bottom: {x: 0, y: -1},
              back: {x: 0, y: 2}
            }
          },
          {
            name: 'T字型',
            layout: {
              left: {x: -1, y: 0},
              front: {x: 0, y: 0},
              right: {x: 1, y: 0},
              back: {x: 2, y: 0},
              top: {x: 0, y: 1},
              bottom: {x: 0, y: -1}
            }
          },
          {
            name: 'L字型A',
            layout: {
              front: {x: 0, y: 0},
              top: {x: 0, y: 1},
              bottom: {x: 0, y: -1},
              right: {x: 1, y: -1},
              back: {x: 1, y: -2},
              left: {x: -1, y: 0}
            }
          },
          {
            name: '階段型',
            layout: {
              left: {x: -1, y: 0},
              front: {x: 0, y: 0},
              right: {x: 1, y: 0},
              back: {x: 2, y: 0},
              bottom: {x: 1, y: -1},
              top: {x: 2, y: 1}
            }
          },
          {
            name: '一直線型',
            layout: {
              left: {x: -2, y: 0},
              front: {x: -1, y: 0},
              right: {x: 0, y: 0},
              back: {x: 1, y: 0},
              top: {x: 2, y: 0},
              bottom: {x: 3, y: 0}
            }
          },
          {
            name: 'Z字型',
            layout: {
              left: {x: -1, y: 0},
              front: {x: 0, y: 0},
              right: {x: 1, y: 0},
              back: {x: 1, y: -1},
              top: {x: 0, y: 1},
              bottom: {x: -1, y: 1}
            }
          },
          {
            name: 'W字型',
            layout: {
              left: {x: -1, y: 0},
              front: {x: 0, y: 0},
              right: {x: 1, y: 0},
              top: {x: 0, y: 1},
              bottom: {x: 1, y: -1},
              back: {x: 2, y: 0}
            }
          },
          {
            name: 'L字型B',
            layout: {
              left: {x: -1, y: 0},
              front: {x: 0, y: 0},
              top: {x: 0, y: 1},
              right: {x: 1, y: 0},
              back: {x: 1, y: 1},
              bottom: {x: -1, y: 1}
            }
          }
        ];

        this.createFaces();

        const sceneEl = this.el.sceneEl;
        const sceneReadyHandler = () => {
          this.patternInfoEl = document.querySelector('#pattern-info');
          this.stateInfoEl = document.querySelector('#fold-state');
          this.updatePatternInfo();
          this.updateStateText();
          this.updatePatternHighlight(this.data.patternIndex);
        };

        if (sceneEl.hasLoaded) {
          sceneReadyHandler();
        } else {
          sceneEl.addEventListener('loaded', sceneReadyHandler, {once: true});
        }
      },

      createFaces: function () {
        const el = this.el;

        this.faceDefinitions.forEach((face) => {
          const faceEl = document.createElement('a-plane');
          faceEl.setAttribute('width', '1');
          faceEl.setAttribute('height', '1');
          faceEl.setAttribute('material', `color: ${face.color}; side: double; metalness: 0; roughness: 1`);
          faceEl.setAttribute('position', face.pos);
          faceEl.setAttribute('rotation', face.rot);
          faceEl.setAttribute('data-face-name', face.name);

          const text = document.createElement('a-text');
          text.setAttribute('value', face.name.toUpperCase());
          text.setAttribute('align', 'center');
          text.setAttribute('position', '0 0 0.01');
          text.setAttribute('scale', '0.45 0.45 0.45');
          text.setAttribute('color', '#111');
          faceEl.appendChild(text);

          el.appendChild(faceEl);
          this.faces.push(faceEl);
        });
      },

      toggle: function () {
        if (this.isAnimating) { return; }
        this.data.isUnfolded = !this.data.isUnfolded;
        this.updateStateText();
        this.animate();
      },

      changePattern: function (index) {
        if (this.isAnimating) { return; }
        if (index < 0 || index >= this.unfoldPatterns.length) { return; }

        this.data.patternIndex = index;
        this.updatePatternInfo();
        this.updatePatternHighlight(index);

        if (this.data.isUnfolded) {
          this.animate();
        }
      },

      animate: function () {
        this.isAnimating = true;
        const duration = this.animationDuration;

        this.faces.forEach((faceEl) => {
          const faceName = faceEl.getAttribute('data-face-name');
          const target = this.data.isUnfolded ? this.getUnfoldTarget(faceName) : this.getFoldTarget(faceName);

          if (!target) { return; }

          faceEl.setAttribute('animation__position', {
            property: 'position',
            to: `${target.position.x} ${target.position.y} ${target.position.z}`,
            dur: duration,
            easing: 'easeInOutQuad'
          });

          faceEl.setAttribute('animation__rotation', {
            property: 'rotation',
            to: `${target.rotation.x} ${target.rotation.y} ${target.rotation.z}`,
            dur: duration,
            easing: 'easeInOutQuad'
          });
        });

        setTimeout(() => {
          this.isAnimating = false;
        }, duration);
      },

      getFoldTarget: function (faceName) {
        return this.faceDefinitions.find((face) => face.name === faceName);
      },

      getUnfoldTarget: function (faceName) {
        const pattern = this.unfoldPatterns[this.data.patternIndex];
        const layout = pattern.layout[faceName];

        if (!layout) { return null; }

        const position = {
          x: (layout.x || 0) * this.layoutSpacing,
          y: (layout.y || 0) * this.layoutSpacing,
          z: layout.z ? layout.z * this.layoutSpacing : 0
        };

        const rotation = layout.rot || {x: 0, y: 0, z: 0};

        return {position, rotation};
      },

      updatePatternInfo: function () {
        if (!this.patternInfoEl) { return; }
        const pattern = this.unfoldPatterns[this.data.patternIndex];
        this.patternInfoEl.setAttribute('value', `現在の展開図: ${pattern.name}`);
      },

      updateStateText: function () {
        if (!this.stateInfoEl) { return; }
        const stateLabel = this.data.isUnfolded ? '展開中' : '立方体';
        this.stateInfoEl.setAttribute('value', `状態: ${stateLabel}`);
      },

      updatePatternHighlight: function (activeIndex) {
        const buttons = document.querySelectorAll('.pattern-button');
        buttons.forEach((btn) => {
          const index = parseInt(btn.dataset.patternIndex, 10);
          const baseColor = btn.dataset.defaultColor || '#3498DB';
          const color = index === activeIndex ? '#16A085' : baseColor;
          btn.setAttribute('color', color);
        });
      }
    });

    AFRAME.registerComponent('clickable-button', {
      schema: {
        action: {type: 'string', default: 'toggle'}
      },

      init: function () {
        const el = this.el;
        el.classList.add('clickable');
        el.dataset.defaultColor = el.getAttribute('color') || '#3498DB';

        el.addEventListener('mouseenter', () => {
          el.object3D.scale.set(1.1, 1.1, 1.1);
        });

        el.addEventListener('mouseleave', () => {
          el.object3D.scale.set(1, 1, 1);
        });

        el.addEventListener('click', () => {
          const cube = document.querySelector('#cube');
          const component = cube && cube.components['cube-unfold'];
          if (!component) { return; }

          if (this.data.action === 'toggle') {
            component.toggle();
            return;
          }

          const patternIndex = parseInt(this.data.action, 10);
          if (Number.isNaN(patternIndex)) { return; }

          component.changePattern(patternIndex);
        });
      }
    });
  </script>
</head>
<body>
  <a-scene renderer="colorManagement: true; physicallyCorrectLights: true;">
    <a-entity id="rig" position="0 1.6 3">
      <a-entity id="camera" camera look-controls wasd-controls>
        <a-cursor
          color="#00FFAA"
          opacity="0.85"
          fuse="false"
          raycaster="objects: .clickable">
        </a-cursor>
      </a-entity>

      <a-entity
        id="leftHand"
        laser-controls="hand: left"
        raycaster="objects: .clickable; lineColor: #FF6B6B; lineOpacity: 0.6">
      </a-entity>

      <a-entity
        id="rightHand"
        laser-controls="hand: right"
        raycaster="objects: .clickable; lineColor: #45B7D1; lineOpacity: 0.6">
      </a-entity>
    </a-entity>

    <a-entity id="cube" position="0 1.5 -1.8" cube-unfold></a-entity>

    <a-entity id="control-panel" position="-1.8 1.5 -2.1" rotation="0 20 0">
      <a-plane width="2.2" height="2.8" color="#243447" opacity="0.95" material="roughness: 1"></a-plane>

      <a-text value="展開図コントロール" position="0 1.15 0.05" align="center" width="2" color="#ECF0F1"></a-text>

      <a-box position="0 0.75 0.1" width="1.7" height="0.4" depth="0.12" color="#27AE60" clickable-button="action: toggle">
        <a-text value="展開 / 折りたたみ" align="center" position="0 0 0.08" width="1.6" color="#FFFFFF"></a-text>
      </a-box>

      <a-text value="展開図パターン選択" position="0 0.32 0.05" align="center" width="2" color="#F1C40F"></a-text>

      <a-entity position="0 -0.05 0">
        <a-box class="pattern-button" data-pattern-index="0" position="-0.55 0.45 0.1" width="0.75" height="0.35" depth="0.12" color="#3498DB" clickable-button="action: 0">
          <a-text value="1. 十字" align="center" position="0 0 0.07" width="0.6" color="#FFFFFF"></a-text>
        </a-box>

        <a-box class="pattern-button" data-pattern-index="1" position="0.55 0.45 0.1" width="0.75" height="0.35" depth="0.12" color="#3498DB" clickable-button="action: 1">
          <a-text value="2. T字" align="center" position="0 0 0.07" width="0.6" color="#FFFFFF"></a-text>
        </a-box>

        <a-box class="pattern-button" data-pattern-index="2" position="-0.55 0.05 0.1" width="0.75" height="0.35" depth="0.12" color="#3498DB" clickable-button="action: 2">
          <a-text value="3. L字A" align="center" position="0 0 0.07" width="0.6" color="#FFFFFF"></a-text>
        </a-box>

        <a-box class="pattern-button" data-pattern-index="3" position="0.55 0.05 0.1" width="0.75" height="0.35" depth="0.12" color="#3498DB" clickable-button="action: 3">
          <a-text value="4. 階段" align="center" position="0 0 0.07" width="0.6" color="#FFFFFF"></a-text>
        </a-box>

        <a-box class="pattern-button" data-pattern-index="4" position="-0.55 -0.35 0.1" width="0.75" height="0.35" depth="0.12" color="#3498DB" clickable-button="action: 4">
          <a-text value="5. 一直線" align="center" position="0 0 0.07" width="0.6" color="#FFFFFF"></a-text>
        </a-box>

        <a-box class="pattern-button" data-pattern-index="5" position="0.55 -0.35 0.1" width="0.75" height="0.35" depth="0.12" color="#3498DB" clickable-button="action: 5">
          <a-text value="6. Z字" align="center" position="0 0 0.07" width="0.6" color="#FFFFFF"></a-text>
        </a-box>

        <a-box class="pattern-button" data-pattern-index="6" position="-0.55 -0.75 0.1" width="0.75" height="0.35" depth="0.12" color="#3498DB" clickable-button="action: 6">
          <a-text value="7. W字" align="center" position="0 0 0.07" width="0.6" color="#FFFFFF"></a-text>
        </a-box>

        <a-box class="pattern-button" data-pattern-index="7" position="0.55 -0.75 0.1" width="0.75" height="0.35" depth="0.12" color="#3498DB" clickable-button="action: 7">
          <a-text value="8. L字B" align="center" position="0 0 0.07" width="0.6" color="#FFFFFF"></a-text>
        </a-box>
      </a-entity>
    </a-entity>

    <a-text id="pattern-info" value="現在の展開図: 十字型" position="0 2.4 -1.8" align="center" width="4" color="#F1C40F"></a-text>
    <a-text id="fold-state" value="状態: 立方体" position="0 2.1 -1.8" align="center" width="3" color="#ECF0F1"></a-text>
    <a-text value="カーソルまたはコントローラーでパネルを操作" position="0 2.75 -1.8" align="center" width="4.2" color="#BDC3C7"></a-text>

    <a-ring position="0 0.01 -1.8" rotation="-90 0 0" radius-inner="0.8" radius-outer="1" color="#3A506B" material="opacity: 0.45"></a-ring>
    <a-plane position="0 0 -1.8" rotation="-90 0 0" width="20" height="20" color="#1B262C" material="roughness: 1"></a-plane>

    <a-light type="ambient" color="#666"></a-light>
    <a-light type="directional" color="#FFFFFF" intensity="0.9" position="1 4 2" cast-shadow="true"></a-light>

    <a-sky color="#0B172A"></a-sky>
  </a-scene>
</body>
</html>
